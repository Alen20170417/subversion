This branch implements the 'invoke-diff-cmd' feature and is located at 
https://svn.apache.org/repos/asf/subversion/branches/invoke-diff-cmd-feature/

It is a feature branch, receiving regular sync merges from /trunk, and
expected to be reintegrated back thereto.

See: http://subversion.tigris.org/issues/show_bug.cgi?id=2044 for the
original motivation for this project.


======================================================================
        INVOKE-DIFF-CMD SECTION
======================================================================

--invoke-diff-cmd allows command line selection of an external diff
program and will be extended to cover the existing diff3 option with a
similar --invoke-diff3-cmd option.

Currently this capability is provided by user written shell scripts
which are passed as the diff program via the svn config file.

--invoke-diff-cmd is currently implemented for 'diff', 'log',
'svnlook' and the config file.


What --invoke-diff-cmd provides
===============================

Users can type 'free-style' command lines for their selected
diff/merge program, and optionally select a diff command file that
applies stored commands to selected files.  If the file diffed is not
in the list, the given command will be used instead.  

from 'svn help diff':

  --invoke-diff-cmd ARG:

       use ARG as format string for external diff command     
        invocation. 
                    
        Substitutions: %svn_new new file                      
                       %svn_old old file                      
                       %svn_label_new  label of the new file  
                       %svn_label_old  label of the old file  
        Examples:                                              
        --invoke-diff-cmd='diff -y %svn_new %svn_old'      
        --invoke-diff-cmd="kdiff3 -auto -o /home/u/log \     
              %svn_new %svn_old --L1 %svn_new_label \      
             --L2 "Custom Label" '                          
        Substitution variables may be embedded in strings:
        +%svn_new, %svn_new- and file=%svn_label_new+


Structure of the feature:
=========================

API components 
--------------

   ./subversion/libsvn_subr/io.c __create_custom_diff_cmd()
 
   transforms the user input 'invoke-diff-cmd' into a command line
   call by substitution the labels and file names(where defined),
   whilst leaving everything else untouched.  This is more of an
   internal routine and probably not well placed in the public API.
   It will be reused for the merge part of this project.


   ./subversion/libsvn_subr/io.c svn_io_run_external_diff()

   calls __create_custom_diff_cmd() and does all the error checking
   required, before routing the result to the actual call to the APR
   routine that makes it.


UI components
-------------

  --invoke-diff-cmd and its user interface components for the command
  line have been installed everywhere where --diff-cmd is available,
  in svnlook.c, svn.c, svnlog.c.

  Users can specify the following mutually exclusive options:

  --invoke-diff-cmd, --diff-cmd and --internal-diff-cmd, and also
  define what diff program to use via the ./svn/config file, using the
  new config file parameter "invoke-diff-cmd"..

  The selection first defaults to the internal diff program, then to
  the config file entry (if defined) which in turn is overridden when
  one of --invoke-diff-cmd, --diff-cmd or --internal-diff-cmd are
  invoked.


Changes to the existing code structure:
=======================================

None.

The existing --diff-cmd has been in use for years and is best left
untouched, since many users will not require the extra services
offered by the --invoke-diff-cmd feature, and any errors could cause
many users a lot of problems.  

Moreover, the nature of --invoke-diff-cmd and --diff-cmd are quite
different; --diff-cmd is tailored for GNU diff and carefully checks the
user's input of switches, whereas --invoke-diff-cmd is a
free-style-anything-goes-including-shooting-your-foot creation.


Tests
=====

The test for the 'invoke-diff-cmd' feature is

  /subversion/tests/cmdline/diff_tests.py diff_invoke_external_diffcmd



Log messages of salient code changes
====================================

* subversion/include/private/svn_io_private.h

  (svn_io__create_custom_diff_cmd): New function declaration.


* subversion/libsvn_client/diff.c

  (diff_cmd_baton): New member: 'invoke_diff_cmd'. Move declaration of
    invoke_diff_cmd to group with diff_cmd.

  (set_up_diff_cmd_and_options): Apply invoke-diff-cmd option 
    preferentially.  Old behavior unchanged.

  (diff_content_changed): Raise an error if both diff_cmd and
    invoke-diff-cmd are set.  Add comment explaining the presence of
    non-canonical path in function call.  Call
    svn_io_run_external_diff if --invoke-diff-cmd option was
    specified, otherwise retain previous behaviour.

  (sub_main): Add guard against concurrent usage of incompatible diff 
    options.  Remove previous guard code. 

  (svn_client_diff_peg_7): Rename and update from
    svn_client_diff_peg_6.  Add new parameter: invoke_diff_cmd.

  (svn_client_diff7): Rename and update from svn_client_diff6, add
    new parameter 'invoke_diff_cmd'.  

  (): Update all comments mentioning 'svn_client_diff6' to
    'svn_client_diff7'.


* subversion/libsvn_subr/config_file.c

  (svn_config_ensure): New entry: invoke-diff-cmd. 

  (invoke-diff-cmd): Update help info.


* subversion/libsvn_subr/io.c

  (svn_io__create_custom_diff_cmd): New function.

  (svn_io_run_diff2):  Add test location information.

  (svn_io_run_external_diff): New function.


* subversion/svn/svn.c

  (svn_cl__cmd_table[]): New option: 'invoke-diff-cmd'.  Add
    opt_invoke_diff_cmd to svn_cl__log entry.  Add opt_invoke_diff_cmd
    to the list of valid subcommands.

  (svn_cl__options "invoke-diff-cmd"): Add help information.  Add new
    variable 'opt_invoke_diff_cmd'.

  (sub_main): Prohibit simultaneous usage of --invoke-diff-cmd and
    --internal-diff. Add new opt_state.diff.invoke-diff-cmd option 
    to the option selector.  Add call to svn_config_set.


* subversion/tests/cmdline/diff_tests.py

  (diff_invoke_external_diffcmd): New function.

  (test_list): Add new entry 'diff_invoke_external_diffcmd'.


* subversion/tests/cmdline/getopt_tests_data/svn_help_log_switch_stdout

  (--invoke-diff-cmd): Add new entry to help output data.


* subversion/libsvn_subr/config_file.c

  (invoke-diff-cmd): Add help info.


* subversion/svnlook/svnlook.c

  (enum): New variable svnlook__invoke_diff_cmd.

  (options_table[]): New entry 'invoke-diff-cmd'.

  (cmd_tablcmd[]): Add svnlook__invoke_diff_cmd to diff cmd table
    entry.

  (svnlook_opt_state): New member variable "invoke_diff_cmd".

  (svnlook_ctxt_t): New member variable "invoke_diff_cmd".

  (print_diff_tree): Modify if condition to include new
    invoke_diff_cmd. Add conditional call to
    /include/svn_io.c:svn_io_run_external_diff().

  (get_ctxt_baton): Assign invoke_diff_cmd data.

  (main): Assign opt_arg to opt_state.invoke_diff_cmd.  Add
    exclusiveness test for invoke_diff_cmd and diff_cmd.


* subversion/include/svn_error_codes.h

  (SVN_CLIENT_DIFF_CMD): New macro.


* subversion/svn/log-cmd.c

  (log_receiver_baton): New struct member invoke_diff_cmd.

  (display_diff): New parameter 'invoke_diff_cmd' . Pass
    invoke_diff_cmd parameter into svn_client_diff_peg7().

  (log_entry_receiver): Pass invoke_diff_cmd into display_diff().
 
  (svn_cl__log): Ensure mutual exclusions between invoke_diff_cmd and
    quiet and diff-cmd, require 'diff' option. Populate
    log_receiver_baton member invoke_diff_cmd. 

  (svn_cl__options): Add help info for invoke-diff-cmd option.      

  (svn_client_diff_peg7): Update call to svn_client_diff_peg6 to
    svn_client_diff_peg7.


* subversion/include/svn_client.h 

  (svn_client_diff7, svn_client_diff_peg7): Declare the new API.  Like
    svn_client_diff[_peg]6 but with invoke_diff_cmd parameter.

  (svn_client_diff6, svn_client_diff_peg_6): Deprecate. 


* subversion/include/svn_config.h

  (SVN_CONFIG_OPTION_INVOKE_DIFF_CMD): New definition.


* subversion/include/svn_io.h

   (svn_io_run_external_diff): New function.


* subversion/libsvn_client/deprecated.c

  (svn_client_diff6, svn_client_diff_peg6): New deprecation wrappers.


* subversion/svn/cl.h

  (struct svn_cl__opt_state_t.diff): New member: 'invoke_diff_cmd'.


* subversion/svn/diff-cmd.c

  (svn_cl__diff): Update call to svn_client_diff6 to svn_client_diff7.

