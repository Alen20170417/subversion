This branch implements the 'invoke-diff-cmd' feature and is located at 
https://svn.apache.org/repos/asf/subversion/branches/invoke-diff-cmd-feature/

It is a feature branch, receiving regular sync merges from /trunk, and
expected to be reintegrated back thereto.

See: http://subversion.tigris.org/issues/show_bug.cgi?id=2044 for the
original motivation for this project.

--invoke-diff-cmd allows command line selection of an external diff
program and will be extended to cover the existing diff3 option with a
similar --invoke-diff3-cmd option.

Currently this capability is provided by user written shell scripts
which are passed as the diff program via the svn config file.

--invoke-diff-cmd is currently implemented for 'diff', 'log',
'svnlook' and the config file.


What --invoke-diff-cmd and --invoke-diff3-cmd provide
=====================================================

Users can type 'free-style' command lines for their selected
diff/merge program, from 'svn help diff':

  --invoke-diff-cmd ARG:

       use ARG as format string for external diff command     
        invocation. 
                    
        Substitutions: %svn_new% new file                      
                       %svn_old% old file                      
                       %svn_new_label%  label of the new file  
                       %svn_old_label%  label of the old file  
        Examples:                                              
        --invoke-diff-cmd='diff -y %svn_new% %svn_old%'      
        --invoke-diff-cmd="kdiff3 -auto -o /home/u/log \     
              %svn_new% %svn_old% --L1 %svn_new_label% \      
             --L2 "Custom Label" '                          
        Other constructs possible are:                         
        +%svn_new%, %svn_new%- and +++%svn_new_label%+++       


Structure of the feature:
=========================

API components 
--------------

   ./subversion/libsvn_subr/io.c:3030 __create_custom_diff_cmd()
 
   transforms the user input 'invoke-diff-cmd' into a command line
   call by substitution the labels and file names(where defined),
   whilst leaving everything else untouched.  This is more of an
   internal routine and probably not well placed in the public API.
   It will be reused for the merge part of this project.


   ./subversion/libsvn_subr/io.c:3108 svn_io_run_external_diff()

   calls __create_custom_diff_cmd() and does all the error checking
   required, before routing the result to the actual call to the APR
   routine that makes it.
 

UI components
-------------

  --invoke-diff-cmd and its user interface components for the command
  line have been installed everywhere where --diff-cmd is available,
  in svnlook.c, svn.c, svnlog.c.

  Users can specify the following mutually exclusive options:

  --invoke-diff-cmd, --diff-cmd and --internal-diff-cmd, and also
  define what diff program to use via the ./svn/config file, using the
  new config file parameter "invoke-diff-cmd"..

  The selection first defaults to the internal diff program, then to
  the config file entry (if defined) which in turn is overridden when
  one of --invoke-diff-cmd, --diff-cmd or --internal-diff-cmd are
  invoked.


Changes to the existing code structure:
=======================================

The original --diff-cmd parsing and routing code has been refactored
and the call to --diff-cmd is now handled by the
__create_custom_diff_cmd() and svn_io_run_external_diff() routines.
All the original functionality and user syntax has been retained.


Tests
=====

The test for the 'invoke-diff-cmd' feature is

  /subversion/tests/cmdline/diff_tests.py diff_invoke_external_diffcmd

The test for the updated --diff-cmd is 

  /subversion/tests/cmdline/diff_tests.py diff_external_diffcmd


TODO:
====

  * add help info to log, svnlook 

  * Adding invoke-diff-cmd to merge:
    add --invoke-diff-3-cmd using the svn_io_create_custom_diff_cmd()
    and creating a new svn_io_run_external_merge function to manage
    the external call in the same way that svn_io_run_external_diff
    does.  Add the necessary UI components.  Add --invoke-diff-3-cmd
    to 'svn up'.

  * Fix the issue of unclear labels being displayed in external merge
    programs:

       http://subversion.tigris.org/issues/show_bug.cgi?id=3836


Review tools
============

The entire code of the branch can be obtained thus:

svn diff ^/subversion/trunk@1531612\
 ^/subversion/branches/invoke-diff-cmd-feature

To obtain a visitable list of files with line numbers in the Emacs
compilation buffer:

M-x cd /branches/invoke-diff-cmd-feature/
M-x compile 
svn diff ^/subversion/trunk@1531612\
 ^/subversion/branches/invoke-diff-cmd-feature |\
 perl -ne '/Index: (.*)$/ && ($name = $1);
 /^@@.*\+(\d+),/ && print "./$name:$1:diff\n";'


Log messages of salient code changes 
====================================

* subversion/include/svn_client.h 

  (svn_client_diff7, svn_client_diff_peg7): Declare the new API.  Like
    svn_client_diff[_peg]6 but with invoke_diff_cmd parameter.

  (svn_client_diff6, svn_client_diff_peg_6): Deprecate. 


* subversion/svn/log-cmd.c 

  (svn_client_diff_peg7): Update call to svn_client_diff_peg6 to
    svn_client_diff_peg7.

  (log_receiver_baton): New struct member invoke_diff_cmd.

  (display_diff): New parameter 'invoke_diff_cmd' . Pass
    invoke_diff_cmd parameter into svn_client_diff_peg7().

  (log_entry_receiver): Pass invoke_diff_cmd into display_diff().
 
  (svn_cl__log): Ensure mutual exclusions between invoke_diff_cmd and
    quiet and diff-cmd, require 'diff' option. Populate
    log_receiver_baton member invoke_diff_cmd.  

  (svn_cl__options): Expand help info for invoke-diff-cmd option.      


* subversion/include/svn_config.h

  (SVN_CONFIG_OPTION_INVOKE_DIFF_CMD): New definition.


* subversion/include/svn_io.h

   (svn_io_create_custom_diff_cmd): New function.

   (svn_io_run_external_diff): New function.
 
   (svn_io_run_diff2): Deprecate function.


* subversion/libsvn_client/deprecated.c

  (svn_client_diff6, svn_client_diff_peg6): New deprecation wrappers.


* subversion/libsvn_client/diff.c

  (struct diff_cmd_baton): New member: 'invoke_diff_cmd'.

  (diff_content_changed): Call svn_io_run_external_diff if
    --invoke-diff-cmd option was specified, otherwise retain previous
    behaviour.

  (set_up_diff_cmd_and_options): Apply invoke-diff-cmd option 
    preferentially.  Old behaviour unchanged.
   
  (svn_client_diff_peg_7): Rename and update from
    svn_client_diff_peg_6.  Add new parameter: invoke_diff_cmd.

  (svn_client_diff7): Rename and update from svn_client_diff6, add
    new parameter 'invoke_diff_cmd'.  

  (): Update all comments mentioning 'svn_client_diff6' to
    'svn_client_diff7'.

  (diff_content_changed): Raise an error if both diff_cmd and
    invoke-diff-cmd are set.


* subversion/libsvn_subr/config_file.c

  (svn_config_ensure): New entry: invoke-diff-cmd. 


* subversion/libsvn_subr/io.c

  (svn_io_create_custom_diff_cmd): New function.

  (svn_io_run_external_diff): New function.


* subversion/svn/cl.h

  (struct svn_cl__opt_state_t.diff): New member: 'invoke_diff_cmd'.


* subversion/svn/diff-cmd.c

  (svn_cl__diff): Update call to svn_client_diff6 to svn_client_diff7.


* subversion/svn/svn.c

  (svn_cl__options[]): Add help info and new variable: 
    'opt_invoke_diff_cmd'.

  (svn_cl__cmd_table[]): New option: 'invoke-diff-cmd'.

  (sub_main): Prohibit simultaneous usage of --invoke-diff-cmd and
    --internal-diff. Add new opt_state.diff.invoke-diff-cmd option 
    to the option selector.  Add call to svn_config_set.

  (svn_cl__cmd_table): Add opt_invoke_diff_cmd to the list of valid
    sub-commands. 

  (sub_main): Add guard against concurrent usage of incompatible diff 
    options.  Remove previous guard code. 


* subversion/tests/cmdline/diff_tests.py

  (diff_invoke_external_diffcmd): New function.

  (test_list): Add new entry 'diff_invoke_external_diffcmd'.


* subversion/include/svn_error_codes.h

  (SVN_CLIENT_DIFF_CMD): New macro.


* subversion/svnlook/svnlook.c

  (enum): New variable svnlook__invoke_diff_cmd.

  (options_table[]): New entry 'invoke-diff-cmd'.

  (cmd_tablcmd[]): Add svnlook__invoke_diff_cmd to diff cmd table
    entry.

  (svnlook_opt_state): New member variable "invoke_diff_cmd".

  (svnlook_ctxt_t): New member variable "invoke_diff_cmd".

  (print_diff_tree): Modify if condition to include new
    invoke_diff_cmd. Add conditional call to
    /include/svn_io.c:svn_io_run_external_diff().

  (get_ctxt_baton): Assign invoke_diff_cmd data.

  (main): Assign opt_arg to opt_state.invoke_diff_cmd.  Add
    exclusiveness test for invoke_diff_cmd and diff_cmd.


